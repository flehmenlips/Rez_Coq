<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: https://cdn.jsdelivr.net">
    <title>Restaurant Reservation</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .reservation-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .reservation-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-top: 2rem;
        }
        .page-title {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .form-control {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .form-control:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        .btn-primary {
            background-color: #4CAF50;
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
        .nav-container {
            display: flex;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem 0;
        }
        .help-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .reservation-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        @media (max-width: 768px) {
            .reservation-form {
                grid-template-columns: 1fr;
            }
            .reservation-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="nav-container">
        <div id="customerNav">
            <a href="/customer-dashboard" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to My Account
            </a>
        </div>
        <div id="adminNav" style="display: none;">
            <a href="/dashboard" class="btn btn-outline-primary">Admin Dashboard</a>
        </div>
    </div>

    <div class="reservation-container">
        <h1 class="page-title">Make a Reservation</h1>
        
        <div class="reservation-card">
            <form id="reservationForm">
                <div class="reservation-form">
                    <div class="form-group">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="time" class="form-label">Time</label>
                        <select class="form-control" id="time" name="time" required>
                            <option value="">Please select a date first to see available times</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="guests" class="form-label">Number of Guests <span id="partyLimit" class="text-muted"></span></label>
                        <input type="number" 
                               class="form-control" 
                               id="guests" 
                               name="guests" 
                               min="1" 
                               required
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top">
                        <small class="help-text">For larger groups, please call us directly</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="form-group full-width text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton">Complete Reservation</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="time-slot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select a Time</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="time-slots" id="timeSlots">
                    <!-- Time slots will be populated here -->
                </div>
                <div id="timeSlotLoading" class="text-center p-3" style="display: none;">
                    <div class="spinner"></div>
                    <p class="mt-2">Loading available times...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Reservation Confirmed!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Your reservation has been successfully created!
                    </div>
                    <div id="reservationDetails" class="mt-3">
                        <!-- Details will be inserted here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="errorMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="validationModalLabel">Invalid Party Size</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="validationMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
    // Prevent form from submitting normally
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        
        try {
            // Disable form and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Format date for display
            const formattedDate = new Date(data.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to create reservation');
            }
            
            if (result.success) {
                // Update confirmation modal content
                document.getElementById('reservationDetails').innerHTML = `
                    <div class="reservation-details">
                        <p><strong>Date:</strong> ${formattedDate}</p>
                        <p><strong>Time:</strong> ${data.time}</p>
                        <p><strong>Number of Guests:</strong> ${data.guests}</p>
                        <p><strong>Reserved for:</strong> ${data.name}</p>
                        <p><strong>Confirmation Email:</strong> ${data.email}</p>
                        <p class="text-muted mt-3">A confirmation email will be sent to your address.</p>
                        <p class="text-muted">Reservation ID: #${result.reservation.id}</p>
                    </div>
                `;
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                modal.show();
                
                // Add event handler for when modal is hidden
                document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', function () {
                    window.location.href = '/customer-dashboard';
                });
                
                // Reset form
                form.reset();
            } else {
                throw new Error(result.message || 'Failed to create reservation');
            }
        } catch (error) {
            console.error('Error:', error);
            // Show error in modal
            document.getElementById('errorMessage').textContent = error.message;
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
        } finally {
            // Restore button state
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    });

    // Prevent form from submitting on enter key
    document.getElementById('reservationForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // Set up date constraints based on settings
    async function setupDatePicker() {
        try {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            
            const dateInput = document.getElementById('date');
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + parseInt(settings.reservation_window));
            
            // Set min date to today
            dateInput.min = today.toISOString().split('T')[0];
            // Set max date based on window
            dateInput.max = maxDate.toISOString().split('T')[0];
            
            console.log('Date picker configured:', {
                min: dateInput.min,
                max: dateInput.max,
                window: settings.reservation_window
            });

            // Update guests input max value
            const guestsInput = document.getElementById('guests');
            guestsInput.max = settings.max_party_size;
            guestsInput.title = `Maximum party size is ${settings.max_party_size}`;
        } catch (error) {
            console.error('Error setting up date picker:', error);
        }
    }

    async function setupGuestsValidation() {
        try {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            
            const guestsInput = document.getElementById('guests');
            const maxPartySize = parseInt(settings.max_party_size);
            const dailyMaxGuests = parseInt(settings.daily_max_guests);
            
            // Update label with max party size
            document.getElementById('partyLimit').textContent = `(Parties of ${maxPartySize} or less)`;
            
            // Set input attributes
            guestsInput.max = maxPartySize;
            guestsInput.title = `Maximum party size is ${maxPartySize}`;
            
            // Add input validation
            guestsInput.addEventListener('input', function(e) {
                const value = parseInt(this.value);
                if (value > maxPartySize) {
                    // Show validation modal
                    document.getElementById('validationMessage').textContent = 
                        `Party size cannot exceed ${maxPartySize} guests. For larger groups, please contact us directly.`;
                    new bootstrap.Modal(document.getElementById('validationModal')).show();
                    
                    // Reset to max allowed value
                    this.value = maxPartySize;
                }
            });
            
            // Add date change listener to check daily capacity
            document.getElementById('date').addEventListener('change', async function(e) {
                const date = this.value;
                if (date) {
                    try {
                        const response = await fetch(`/api/reservations/daily-count?date=${date}`);
                        const data = await response.json();
                        const currentTotal = parseInt(data.total_guests || 0);
                        const remainingCapacity = dailyMaxGuests - currentTotal;
                        
                        // Update guests input max based on remaining capacity
                        const newMax = Math.min(maxPartySize, remainingCapacity);
                        guestsInput.max = newMax;
                        
                        if (remainingCapacity <= 0) {
                            document.getElementById('validationMessage').textContent = 
                                `We're fully booked for this date. Please select another date.`;
                            new bootstrap.Modal(document.getElementById('validationModal')).show();
                            this.value = ''; // Clear the date
                        } else if (remainingCapacity < maxPartySize) {
                            document.getElementById('validationMessage').textContent = 
                                `Due to capacity limits, we can only accommodate parties of ${newMax} or less for this date.`;
                            new bootstrap.Modal(document.getElementById('validationModal')).show();
                        }
                        
                        // Update help text
                        guestsInput.title = `Maximum party size for this date is ${newMax}`;
                        document.getElementById('partyLimit').textContent = 
                            `(Parties of ${newMax} or less for this date)`;
                    } catch (error) {
                        console.error('Error checking daily capacity:', error);
                    }
                }
            });
        } catch (error) {
            console.error('Error setting up guests validation:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        setupDatePicker();
        setupGuestsValidation();
    });

    // Add time slot population
    document.getElementById('date').addEventListener('change', async (e) => {
        const date = e.target.value;
        const timeSelect = document.getElementById('time');
        timeSelect.innerHTML = '<option value="">Loading times...</option>';
        timeSelect.disabled = true;
        
        try {
            console.log('Fetching available times...');
            const response = await fetch('/api/reservations/available-times');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server response:', errorText);
                throw new Error(`Failed to fetch available times: ${response.status} ${errorText}`);
            }
            
            const times = await response.json();
            console.log('Available times:', times);
            
            if (!Array.isArray(times)) {
                throw new Error('Server returned invalid time slot format');
            }
            
            timeSelect.innerHTML = '<option value="">Select a time</option>';
            
            if (times.length === 0) {
                timeSelect.innerHTML = '<option value="">No times available</option>';
                return;
            }
            
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching times:', error);
            timeSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
        } finally {
            timeSelect.disabled = false;
        }
    });

    // Check auth status on page load
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check-session');
            const result = await response.json();
            if (!result.authenticated) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login';
        }
    }
    
    document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>