<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: https://cdn.jsdelivr.net">
    <title>Restaurant Reservation</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .reservation-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .reservation-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-top: 2rem;
        }
        .page-title {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .form-control {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .form-control:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        .btn-primary {
            background-color: #4CAF50;
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
        .nav-container {
            display: flex;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem 0;
        }
        .help-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .reservation-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        @media (max-width: 768px) {
            .reservation-form {
                grid-template-columns: 1fr;
            }
            .reservation-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="nav-container">
        <div id="customerNav">
            <a href="/customer-dashboard" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to My Account
            </a>
        </div>
        <div id="adminNav" style="display: none;">
            <a href="/dashboard" class="btn btn-outline-primary">Admin Dashboard</a>
        </div>
    </div>

    <div class="reservation-container">
        <h1 class="page-title">Make a Reservation</h1>
        
        <div class="reservation-card">
            <form id="reservationForm">
                <div class="reservation-form">
                    <div class="form-group">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="time" class="form-label">Time</label>
                        <select class="form-control" id="time" name="time" required>
                            <option value="">Please select a date first to see available times</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="guests" class="form-label">Number of Guests</label>
                        <input type="number" 
                               class="form-control" 
                               id="guests" 
                               name="guests" 
                               min="1" 
                               required
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="For larger groups, please call us directly">
                        <small class="help-text">Maximum party size varies by time and date</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="form-group full-width text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Complete Reservation</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="time-slot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select a Time</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="time-slots" id="timeSlots">
                    <!-- Time slots will be populated here -->
                </div>
                <div id="timeSlotLoading" class="text-center p-3" style="display: none;">
                    <div class="spinner"></div>
                    <p class="mt-2">Loading available times...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel">Reservation Confirmed!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-success" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>
              Your reservation has been successfully created!
            </div>
            <div id="reservationDetails" class="mt-3">
              <!-- Details will be inserted here by JavaScript -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <span id="errorMessage"></span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
    // Prevent form from submitting normally
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();  // This is crucial
        
        // Disable form to prevent double submission
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const allInputs = form.querySelectorAll('input, select, button');
        
        // Disable all form elements
        allInputs.forEach(input => input.disabled = true);
        if (submitButton) {
            submitButton.innerHTML = 'Submitting...';
        }
        
        const formData = {
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            guests: document.getElementById('guests').value,
            email: document.getElementById('email').value,
            name: document.getElementById('name').value
        };
        
        try {
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'  // Added this to prevent raw JSON display
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Format date for display
                const formattedDate = new Date(formData.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Update modal content
                document.getElementById('reservationDetails').innerHTML = `
                    <div class="reservation-details">
                        <p><strong>Date:</strong> ${formattedDate}</p>
                        <p><strong>Time:</strong> ${formData.time}</p>
                        <p><strong>Number of Guests:</strong> ${formData.guests}</p>
                        <p><strong>Reserved for:</strong> ${formData.name}</p>
                        <p><strong>Confirmation Email:</strong> ${formData.email}</p>
                        <p class="text-muted mt-3">A confirmation email will be sent to your address.</p>
                        <p class="text-muted">Reservation ID: #${result.id}</p>
                    </div>
                `;
                
                // Show the success modal
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                modal.show();
                
                // Reset form
                form.reset();
            } else {
                throw new Error(result.message || 'Error creating reservation');
            }
        } catch (error) {
            console.error('Error:', error);
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            document.getElementById('errorMessage').textContent = error.message || 'Error creating reservation. Please try again.';
            errorModal.show();
        } finally {
            // Re-enable all form elements
            allInputs.forEach(input => input.disabled = false);
            if (submitButton) {
                submitButton.innerHTML = 'Submit';
            }
        }
    });

    // Prevent form from submitting on enter key
    document.getElementById('reservationForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // Set up date constraints based on settings
    async function setupDatePicker() {
        try {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            
            const dateInput = document.getElementById('date');
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + settings.reservation_window);
            
            // Set min date to today
            dateInput.min = today.toISOString().split('T')[0];
            // Set max date based on window
            dateInput.max = maxDate.toISOString().split('T')[0];
            
            console.log('Date picker configured:', {
                min: dateInput.min,
                max: dateInput.max,
                window: settings.reservation_window
            });
        } catch (error) {
            console.error('Error setting up date picker:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        setupDatePicker();
    });

    // Add time slot population
    document.getElementById('date').addEventListener('change', async (e) => {
        const date = e.target.value;
        const timeSelect = document.getElementById('time');
        timeSelect.innerHTML = '<option value="">Loading times...</option>';
        timeSelect.disabled = true;
        
        try {
            console.log('Fetching available times...');
            const response = await fetch('/api/reservations/available-times');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server response:', errorText);
                throw new Error(`Failed to fetch available times: ${response.status} ${errorText}`);
            }
            
            const times = await response.json();
            console.log('Available times:', times);
            
            if (!Array.isArray(times)) {
                throw new Error('Server returned invalid time slot format');
            }
            
            timeSelect.innerHTML = '<option value="">Select a time</option>';
            
            if (times.length === 0) {
                timeSelect.innerHTML = '<option value="">No times available</option>';
                return;
            }
            
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching times:', error);
            timeSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
        } finally {
            timeSelect.disabled = false;
        }
    });

    // Check auth status on page load
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check-session');
            const result = await response.json();
            if (!result.authenticated) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login';
        }
    }
    
    document.addEventListener('DOMContentLoaded', checkAuth);
    </script>

    <!-- Error Modal -->
    <div class="modal" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Reservation Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="errorMessage"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reservation Confirmed!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reservationDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>